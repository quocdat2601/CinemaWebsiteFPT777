@using System.Web
@model MovieTheater.Models.Movie
@{
    ViewData["Title"] = "Home";
    var movies = ViewBag.Movies as IEnumerable<MovieTheater.Models.Movie>;
    var promotions = ViewBag.Promotions as IEnumerable<MovieTheater.Models.Promotion>;
    // Force view recompilation - ensure proper data handling
    var people = ViewBag.People as IEnumerable<MovieTheater.Models.Person> ?? new List<MovieTheater.Models.Person>();
    var actorNames = people.Where(p => p != null && p.IsDirector == false).Select(p => p.Name ?? "").ToList();
    var directorNames = people.Where(p => p != null && p.IsDirector == true).Select(p => p.Name ?? "").ToList();
    var movieList = movies?.ToList() ?? new List<MovieTheater.Models.Movie>();
    var showsByDate = ViewBag.ShowsByDate as Dictionary<string, List<string>>;
}
<!-- GOOGLE FONTS -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;600;700;900&display=swap" rel="stylesheet">
<!-- OWL CAROUSEL -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
<!-- SWIPER CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
<!-- BOX ICONS -->
<link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
<!-- APP CSS -->
<link rel="stylesheet" href="~/css/grid.css" />
<link rel="stylesheet" href="~/css/app.css" />

<!-- HERO SECTION CSS -->
<link rel="stylesheet" href="~/css/hero-section.css" />

<!-- ===== HERO SECTION PLACEHOLDER ===== -->
<!-- HERO SECTION (d√πng SwiperJS) -->
<section class="hero-section">
    <!-- Background image -->
    <div class="hero-bg" id="hero-bg">
        <div class="hero-bg-track">
            @if (movieList.Count > 0)
            {
                // Clone cu·ªëi v√†o ƒë·∫ßu (th√™m 2 clone ƒë·ªÉ ho√†n thi·ªán loop)
                var lastMovie = movieList[movieList.Count - 1];
                <img class="hero-bg-img" src="@lastMovie.LargeImage" alt="@lastMovie.MovieNameEnglish" data-index="-2" />
                <img class="hero-bg-img" src="@lastMovie.LargeImage" alt="@lastMovie.MovieNameEnglish" data-index="-1" />
            }
            @for (int i = 0; i < movieList.Count; i++)
            {
                var movie = movieList[i];
                <img class="hero-bg-img" src="@movie.LargeImage" alt="@movie.MovieNameEnglish" data-index="@i" />
            }
            @if (movieList.Count > 0)
            {
                // Clone ƒë·∫ßu v√†o cu·ªëi (th√™m 2 clone ƒë·ªÉ ho√†n thi·ªán loop)
                var firstMovie = movieList[0];
                <img class="hero-bg-img" src="@firstMovie.LargeImage" alt="@firstMovie.MovieNameEnglish" data-index="@movieList.Count" />
                <img class="hero-bg-img" src="@firstMovie.LargeImage" alt="@firstMovie.MovieNameEnglish" data-index="@(movieList.Count + 1)" />
            }
        </div>
    </div>

    <!-- Content -->
    <div class="hero-content">
        <div class="hero-info" id="hero-info">
            @if (!string.IsNullOrEmpty(Model?.LogoImage))
            {
                <img class="hero-movie-logo" src="@Model.LogoImage" alt="@Model.MovieNameEnglish Logo">
            }
            else
            {
                <h2 class="hero-title">@Model?.MovieNameEnglish</h2>
            }

            <div class="hero-meta">
                <span><i class="bx bxs-time"></i> @Model?.Duration'</span>
                <span>
                    @if (Model?.Versions != null && Model.Versions.Any())
                    {
                        @(string.Join(", ", Model.Versions.Select(v => v.VersionName)))
                    }
                    else
                    {
                        <span>HD</span>
                    }
                </span>
            </div>

            <div class="hero-desc">
                @Model?.Content
            </div>

            <div class="hero-extra-info">
                <div>
                    <b>Starring: </b> @(string.Join(", ", actorNames))
                </div>
                <div>
                    <b>This show is:</b>
                    @if (Model?.Types != null && Model.Types.Any())
                    {
                        @(string.Join(", ", Model.Types.Select(t => t.TypeName)))
                    }
                </div>
                <div>
                    <b>Directed by: </b>
                    @(string.Join(", ", directorNames))
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation buttons -->
    <button id="hero-prev" class="hero-nav-btn hero-prev" style="background:none; border:none; box-shadow:none; width:auto; height:auto; left:2vw;">
        <i class="bx bx-chevron-left" style="font-size:3.5rem;color:#fff;"></i>
    </button>
    <button id="hero-next" class="hero-nav-btn hero-next" style="background:none; border:none; box-shadow:none; width:auto; height:auto; right:2vw;">
        <i class="bx bx-chevron-right" style="font-size:3.5rem;color:#fff;"></i>
    </button>
    <!-- Side bar navigation invisible -->
    <div class="hero-nav-side hero-nav-side-left" style="position:absolute;top:0;left:0;width:8vw;height:100%;background:transparent;z-index:30;cursor:pointer;"></div>
    <div class="hero-nav-side hero-nav-side-right" style="position:absolute;top:0;right:0;width:8vw;height:100%;background:transparent;z-index:30;cursor:pointer;"></div>

    <!-- Movie carousel (SwiperJS) -->
    <div class="hero-carousel-container">
        <div class="hero-carousel">
            <div class="swiper hero-swiper">
                <div class="swiper-wrapper">
                    @{
                        var activeId = Model?.MovieId;
                    }
                    @for (int i = 0; i < movieList.Count; i++)
                    {
                        var movie = movieList[i];
                        var isActive = movie.MovieId == activeId;
                        <div class="swiper-slide @(isActive ? "active" : "")"
                             data-movie-id="@movie.MovieId"
                             data-movie-name="@movie.MovieNameEnglish"
                             data-movie-duration="@movie.Duration"
                             data-movie-versions="@(string.Join(", ", movie.Versions?.Select(v => v.VersionName) ?? Enumerable.Empty<string>()))"
                             data-movie-content="@movie.Content"
                             data-movie-actor="@(string.Join(", ", movie.People?.Where(p => p.IsDirector == false).Select(p => p.Name) ?? Enumerable.Empty<string>()))"
                             data-movie-types="@(string.Join(", ", movie.Types?.Select(t => t.TypeName) ?? Enumerable.Empty<string>()))"
                             data-movie-director="@(string.Join(", ", movie.People?.Where(p => p.IsDirector == true).Select(p => p.Name) ?? Enumerable.Empty<string>()))"
                             data-movie-largeimage="@movie.LargeImage"
                             data-movie-trailerurl="@movie.TrailerUrl"
                             data-movie-logoimage="@movie.LogoImage">
                            <div class="carousel-img-rect">
                                <img src="@movie.LargeImage" alt="@movie.MovieNameEnglish">
                                @if (!string.IsNullOrEmpty(movie.LogoImage))
                                {
                                    <div class="carousel-logo-wrapper">
                                        <img class="carousel-logo" src="@movie.LogoImage" alt="@movie.MovieNameEnglish Logo">
                                    </div>
                                }
                            </div>
                            <div class="hero-carousel-title">@movie.MovieNameEnglish</div>
                        </div>
                    }
                </div>
                <!-- ƒê√£ x√≥a navigation Swiper ·ªü ƒë√¢y -->
            </div>
        </div>
        <div class="hero-progress">
            <div class="hero-progress-bar" id="hero-progress-bar"></div>
        </div>
    </div>
</section>

<!-- ===== END HERO SECTION PLACEHOLDER ===== -->
<!-- SLIDE 2: NOW SHOWING CAROUSEL (CHUY·ªÇN SANG SWIPER) -->
<section class="web-movie-slide desktop" style="background:transparent; min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
    <!-- Heading MOVIES hi·ªán ƒë·∫°i, n·ªïi b·∫≠t, cƒÉn gi·ªØa to√†n section -->
    <div class="modern-movie-heading" style="margin-bottom:0.5rem; margin-top:2.5rem;">
        <span>MOVIES</span>
    </div>
    <div class="movie-showing" style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <div class="container keep-stable" style="width:80%; margin:2.5rem auto; padding:0 10px;">
            <div class="web-movie-content" style="margin-top:2.2rem;">
                <div class="web-movie-list">
                    <!-- Swiper -->
                    <div class="swiper nowshowing-swiper">
                        <div class="swiper-wrapper">
                            @foreach (var movie in movies ?? Enumerable.Empty<MovieTheater.Models.Movie>())
                            {
                                <div class="swiper-slide" style="padding:0 10px;">
                                    <div class="web-movie-box" style="background:#181a20; border-radius:18px; box-shadow:0 4px 24px rgba(0,0,0,0.13); width:100%; max-width:320px; margin:auto; display:flex; flex-direction:column; align-items:center; padding-bottom:18px;">
                                        <a class="image" href="@Url.Action("Detail", "Movie", new { id = movie.MovieId })" style="display:block; width:100%;">
                                            <img src="@movie.SmallImage" alt="@movie.MovieNameEnglish" style="width:100%; height:450px; object-fit:cover; border-radius:18px 18px 0 0;">
                                        </a>
                                        <div class="content" style="width:100%; text-align:center; margin-top:1rem; padding:0 15px;">
                                            <p class="name" style="font-weight:700; font-size:1.1rem; min-height:48px; color:#fff; margin-bottom:0.5rem; line-height:1.3;">@movie.MovieNameEnglish</p>
                                            <div style="display:flex; justify-content:center; gap:0.7rem; font-size:0.97rem; color:#bbb; margin-bottom:0.7rem">
                                                <div><i class="bx bxs-time"></i> @movie.Duration' </div>
                                                <div>
                                                    @if (movie.Versions?.Any() == true)
                                                    {
                                                        @(string.Join(", ", movie.Versions.Select(v => v.VersionName)))
                                                    }
                                                    else
                                                    {
                                                        <span>HD</span>
                                                    }
                                                </div>
                                                <!-- <div>16+</div> -->
                                            </div>
                                            <div style="display:flex; justify-content:center; gap:0.8rem; flex-wrap:nowrap;">
                                                <a href="#" class="btn btn-outline-light btn-hover watch-trailer-btn" data-trailer-url="@movie.TrailerUrl" style="font-size:0.9rem; padding:0.4rem 1.2rem; border-radius:6px; border:1.5px solid #ffe066; color:#ffe066; background:transparent; font-weight:600; display:inline-flex; align-items:center; gap:0.3rem; white-space:nowrap; min-width:0;">
                                                    <i class="fa fa-play-circle"></i> <span>Watch Trailer</span>
                                                </a>
                                                <button class="btn btn-warning btn-hover book-movie-btn"
                                                        data-movie-id="@movie.MovieId"
                                                        data-movie-name="@Html.Raw(HttpUtility.JavaScriptStringEncode(movie.MovieNameEnglish))"
                                                        style="font-size:0.9rem; padding:0.4rem 1.2rem; border-radius:6px; font-weight:700; color:#222; background:#ffe066; border:none; white-space:nowrap; min-width:0;">
                                                    Book Now
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <!-- Add Navigation -->
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                </div>
            </div>
            <div style="text-align:center; margin-top:2.2rem; margin-bottom:2.5rem;">
                <a href="@Url.Action("MovieList", "Movie")" class="btn btn-outline-warning btn-hover" style="font-size:1.1rem; font-weight:700; border-radius:8px; padding:0.5rem 2.2rem; border:2px solid #ffe066; color:#ffe066; background:transparent;">
                    <span>View More</span>
                </a>
            </div>
        </div>
    </div>
</section>
<!-- SLIDE 3: PROMOTION + FOOTER G·ªòP CHUNG (gi·ªØ nguy√™n) -->
<section class="slide-section promo-footer-slide" id="slide-promo-footer" style="min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background:var(--box-bg);">
    <div class="container" style="width:85%; max-width:1400px; margin:auto;">
        <div class="section-header" style="margin-bottom:2rem;">PROMOTION</div>
        <div class="owl-carousel movies-slide carousel-nav-center" id="promotion-carousel">
            @foreach (var promo in promotions ?? Enumerable.Empty<MovieTheater.Models.Promotion>())
            {
                <div class="movie-item">
                    <img src="@promo.Image" alt="Promotion">
                    <div class="movie-item-content">
                        <div class="movie-item-title">
                            @promo.Title
                        </div>
                        <div class="movie-infos">
                            <div class="movie-info">
                                <span>@promo.Detail</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <!-- Footer nh·ªè g·ªçn ph√≠a d∆∞·ªõi -->
        <footer class="section" style="margin-top:3rem;">
            <div class="container">
                <div class="row">
                    <div class="col-4 col-md-6 col-sm-12">
                        <div class="content">
                            <a href="#" class="logo">
                                <span class="movie-logo-icon" style="display:flex;align-items:center;">
                                    <i class='bx bx-movie-play bx-tada main-color' style="font-size:2rem;"></i>
                                    <img src="~/image/logo.png" alt="MovieTheater Logo" style="height:40px; width:auto; display:inline-block; vertical-align:middle; margin-left:8px;">
                                </span>
                            </a>
                            <p style="font-size:0.95rem;">
                                FPT777 Theater - Enjoy your movie time!
                            </p>
                        </div>
                    </div>
                    <div class="col-8 col-md-6 col-sm-12">
                        <div class="row">
                            <div class="col-3 col-md-6 col-sm-6">
                                <div class="content">
                                    <p>
                                        <b>FPT777</b>
                                    </p>
                                    <ul class="footer-menu">
                                        <li><a href="#">About us</a></li>
                                        <li><a href="#">My profile</a></li>
                                        <li><a href="#">Pricing plans</a></li>
                                        <li><a href="#">Contacts</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-3 col-md-6 col-sm-6">
                                <div class="content">
                                    <p><b>Browse</b></p>
                                    <ul class="footer-menu">
                                        <li><a href="#">About us</a></li>
                                        <li><a href="#">My profile</a></li>
                                        <li><a href="#">Pricing plans</a></li>
                                        <li><a href="#">Contacts</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-3 col-md-6 col-sm-6">
                                <div class="content">
                                    <p><b>Help</b></p>
                                    <ul class="footer-menu">
                                        <li><a href="#">About us</a></li>
                                        <li><a href="#">My profile</a></li>
                                        <li><a href="#">Pricing plans</a></li>
                                        <li><a href="#">Contacts</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-3 col-md-6 col-sm-6">
                                <div class="content">
                                    <p><b>Download app</b></p>
                                    <ul class="footer-menu">
                                        <li>
                                            <a href="#">
                                                <img src="~/images/google-play.png" alt="">
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#">
                                                <img src="~/images/app-store.png" alt="">
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <div class="copyright" style="margin-top:1rem;">Copyright 2024 <a href="#" target="_blank">Team03</a></div>
    </div>
</section>
<!-- Modal for Trailer -->
<div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background:#181a20;">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white" id="trailerModalLabel">Movie Trailer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="height:450px;">
                <iframe id="trailerFrame" width="100%" height="100%" src="" frameborder="0" allowfullscreen allow="autoplay"></iframe>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/hero-section.js"></script>
    <script>
        // Global variables
        window.movieShowsCache = new Map(); // Cache for movie shows
        window.currentMovieShows = [];
        window.availableDates = new Set();

        // Initialize all functions before DOMContentLoaded
        window.initializeBooking = function() {
            // Initialize modal event listeners
            const bookingModal = document.getElementById('addBookingModal');
            if (bookingModal) {
                bookingModal.addEventListener('shown.bs.modal', function () {
                    // Focus on date select when modal opens
                    const dateSelect = document.getElementById('dateSelect');
                    if (dateSelect) {
                        dateSelect.focus();
                    }
                });
            }
        };

        // Function to open booking modal for selected movie
        window.openBookingModal = function(movieId, movieName) {
            console.log('Opening booking modal for movie ID:', movieId);

            // Set the movie ID in the hidden input
            const movieIdInput = document.getElementById('movieId');
            if (movieIdInput) {
                movieIdInput.value = movieId;
                console.log('Movie ID set in input:', movieIdInput.value);
            }

            // Update modal title with movie name
            const modalTitle = document.getElementById('addBookingModalLabel');
            if (modalTitle && movieName) {
                modalTitle.innerHTML = `<i class="fas fa-ticket-alt me-2"></i>Book Tickets for "${movieName}"`;
            }

            // Update the movie name in the modal body
            const movieNameElem = document.getElementById('selectedMovieName');
            if (movieNameElem && movieName) {
                movieNameElem.textContent = movieName;
            }

            // Reset form selections
            const dateSelect = document.getElementById('dateSelect');
            const versionSelect = document.getElementById('versionSelect');
            const timeSelect = document.getElementById('timeSelect');

            if (dateSelect) {
                dateSelect.innerHTML = '<option value="">Loading dates...</option>';
                dateSelect.disabled = true;
            }
            if (versionSelect) {
                versionSelect.innerHTML = '<option value="">‚Äî Select Version ‚Äî</option>';
                versionSelect.disabled = true;
            }
            if (timeSelect) {
                timeSelect.innerHTML = '<option value="">‚Äî Select Time ‚Äî</option>';
                timeSelect.disabled = true;
            }

            // Load movie shows for this specific movie
            window.loadMovieShowsForMovie(movieId, movieName);
        };

        // Function to load movie shows for a specific movie
        window.loadMovieShowsForMovie = function(movieId, movieName) {
            console.log('Loading movie shows for movie ID:', movieId);

            // Check if we already have this movie's shows cached
            if (window.movieShowsCache.has(movieId)) {
                console.log('Using cached movie shows for movie ID:', movieId);
                window.currentMovieShows = window.movieShowsCache.get(movieId);
                window.populateDateDropdown();
                window.showBookingModal();
                return;
            }

            // Fetch movie shows for this specific movie
            fetch(`/Movie/GetMovieShows?movieId=${movieId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received movie shows data:', data);
                    
                    // Filter shows for this specific movie and exclude disabled rooms
                    const filteredShows = data.filter(show => 
                        show.movieId == movieId && show.CinemaRoomStatus !== 3
                    );
                    
                    console.log('Filtered shows for movie', movieId, ':', filteredShows);
                    
                    // Cache the filtered results for this movie
                    window.movieShowsCache.set(movieId, filteredShows);
                    window.currentMovieShows = filteredShows;
                    
                    if (filteredShows.length === 0) {
                        alert('No available showtimes for this movie at the moment.');
                        return;
                    }
                    
                    window.populateDateDropdown();
                    window.showBookingModal();
                })
                .catch(error => {
                    console.error('Error loading movie shows:', error);
                    alert('Error loading movie shows. Please try again.');
                });
        };

        window.populateDateDropdown = function () {
            const dateSelect = document.getElementById('dateSelect');
            dateSelect.innerHTML = '<option value="">‚Äî Select Date ‚Äî</option>';
            dateSelect.disabled = true;

            if (!window.currentMovieShows || window.currentMovieShows.length === 0) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0); // normalize time

            // Convert ShowDate (DateOnly) to string format and get unique dates
            const uniqueDates = [...new Set(window.currentMovieShows.map(show => {
                // Convert DateOnly to yyyy-MM-dd format
                const date = new Date(show.ShowDate);
                return date.toISOString().split('T')[0]; // yyyy-MM-dd format
            }))];

            uniqueDates.forEach(dateStr => {
                const showDate = new Date(dateStr);
                showDate.setHours(0, 0, 0, 0); // normalize show date

                if (showDate >= today) {
                    const [year, month, day] = dateStr.split('-');
                    const displayDate = `${day}/${month}/${year}`;
                    const option = document.createElement('option');
                    option.value = dateStr;
                    option.textContent = displayDate;
                    dateSelect.appendChild(option);
                }
            });

            if (dateSelect.options.length > 1) {
                dateSelect.disabled = false;
            }
        };

        // Populate version dropdown
        window.updateVersions = function() {
            const date = document.getElementById('dateSelect').value;
            const versionSelect = document.getElementById('versionSelect');
            versionSelect.innerHTML = '<option value="">‚Äî Select Version ‚Äî</option>';
            versionSelect.disabled = true;
            document.getElementById('timeSelect').innerHTML = '<option value="">‚Äî Select Time ‚Äî</option>';
            document.getElementById('timeSelect').disabled = true;
            if (!date) return;
            
            // Convert selected date back to DateOnly format for comparison
            const selectedDate = new Date(date);
            const selectedDateOnly = selectedDate.toISOString().split('T')[0];
            
            // Filter shows for the selected date
            const filtered = window.currentMovieShows.filter(show => {
                const showDateOnly = new Date(show.ShowDate).toISOString().split('T')[0];
                return showDateOnly === selectedDateOnly;
            });
            
            // Use a Map to ensure unique versionId-versionName pairs
            const versionMap = new Map();
            filtered.forEach(show => {
                if (show.VersionId && show.VersionName && !versionMap.has(show.VersionId)) {
                    versionMap.set(show.VersionId, show.VersionName);
                }
            });
            versionMap.forEach((name, id) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                versionSelect.appendChild(option);
            });
            versionSelect.disabled = false;
        }

        // Populate time dropdown
        window.updateTimes = function() {
            const date = document.getElementById('dateSelect').value;
            const versionId = document.getElementById('versionSelect').value;
            const timeSelect = document.getElementById('timeSelect');
            timeSelect.innerHTML = '<option value="">‚Äî Select Time ‚Äî</option>';
            timeSelect.disabled = true;
            if (!date || !versionId) return;
            
            // Convert selected date back to DateOnly format for comparison
            const selectedDate = new Date(date);
            const selectedDateOnly = selectedDate.toISOString().split('T')[0];
            
            // Filter shows for the selected date and version
            const filtered = window.currentMovieShows.filter(show => {
                const showDateOnly = new Date(show.ShowDate).toISOString().split('T')[0];
                return showDateOnly === selectedDateOnly && String(show.VersionId) === String(versionId);
            });
            
            // Use a Set to ensure unique times
            const timeSet = new Set();
            filtered.forEach(show => {
                if (show.ScheduleTime && !timeSet.has(show.ScheduleTime)) {
                    const option = document.createElement('option');
                    option.value = show.ScheduleTime;
                    option.textContent = show.ScheduleTime;
                    timeSelect.appendChild(option);
                    timeSet.add(show.ScheduleTime);
                }
            });
            timeSelect.disabled = false;
        }

        window.continueToSeats = function() {
            const movieId = document.getElementById('movieId').value;
            const date = document.getElementById('dateSelect').value;
            const versionId = document.getElementById('versionSelect').value;
            const time = document.getElementById('timeSelect').value;

            if (!movieId || !date || !versionId || !time) {
                alert('Please select all options');
                return;
            }

            const [year, month, day] = date.split('-');
            const formattedDate = `${day}/${month}/${year}`;

            window.location.href = `/Seat/Select?movieId=${movieId}&date=${formattedDate}&versionId=${encodeURIComponent(versionId)}&time=${encodeURIComponent(time)}`;
        }

        // Function to show the booking modal
        window.showBookingModal = function() {
            const bookingModal = new bootstrap.Modal(document.getElementById('addBookingModal'));
            bookingModal.show();
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            var trailerModal = new bootstrap.Modal(document.getElementById('trailerModal'));
            var trailerFrame = document.getElementById('trailerFrame');

            // Trailer button event listeners
            document.querySelectorAll('.watch-trailer-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const trailerUrl = this.getAttribute('data-trailer-url');
                    if (trailerUrl) {
                        trailerFrame.src = trailerUrl;
                        trailerModal.show();
                    }
                });
            });

            // Book movie button event listeners
            document.querySelectorAll('.book-movie-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const movieId = this.getAttribute('data-movie-id');
                    const movieName = this.getAttribute('data-movie-name');
                    if (movieId && movieName) {
                        window.openBookingModal(movieId, movieName);
                    }
                });
            });

            document.getElementById('trailerModal').addEventListener('hidden.bs.modal', function () {
                trailerFrame.src = '';
            });

            window.initializeBooking();
        });
    </script>
}

<div class="modal fade" id="addBookingModal" tabindex="-1" aria-labelledby="addBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-center me-2" style="color: black; font-weight: bold" id="selectedMovieName"></h3>
            </div>
            <div class="modal-body">
                <form id="bookingForm" novalidate>
                    <input type="hidden" id="movieId" name="movieId" value="@Model.MovieId" />
                    <div class="mb-4">
                        <label for="dateSelect" class="form-label booking-label"><span class="label-icon">üóìÔ∏è</span> <strong>Date</strong></label>
                        <select id="dateSelect" class="form-select booking-select" onchange="updateVersions()">
                            <option value="">‚Äî Select Date ‚Äî</option>
                            <!-- Dates will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="versionSelect" class="form-label booking-label"><span class="label-icon">üéûÔ∏è</span> <strong>Version</strong></label>
                        <select id="versionSelect" class="form-select booking-select" disabled onchange="updateTimes()">
                            <option value="">‚Äî Select Version ‚Äî</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="timeSelect" class="form-label booking-label"><span class="label-icon">‚è∞</span> <strong>Time</strong></label>
                        <select id="timeSelect" class="form-select booking-select" disabled>
                            <option value="">‚Äî Select Time ‚Äî</option>
                        </select>
                    </div>
                    <button type="button" id="bookBtn" class="btn booking-btn-gradient w-100 mt-2" onclick="continueToSeats()">
                        <span>Continue to Seat Selection</span> <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
